name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  REGISTRY: docker.io
  IMAGE_NAME_PYTHON: ${{ secrets.DOCKERHUB_USERNAME }}/python-users-service
  IMAGE_NAME_JAVA: ${{ secrets.DOCKERHUB_USERNAME }}/java-products-service

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Test Python dependencies
      working-directory: ./backend/python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "‚úÖ Python dependencies installed"
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Test Java compilation
      working-directory: ./backend/java
      run: |
        mvn clean compile
        echo "‚úÖ Java compilation successful"
    
    - name: Run simple tests
      run: |
        echo "Running basic tests..."
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
        [ -f "docker-compose.yml" ] && echo "‚úÖ docker-compose.yml exists"
        [ -f "backend/python/app.py" ] && echo "‚úÖ Python app exists"
        [ -f "backend/java/pom.xml" ] && echo "‚úÖ Java pom.xml exists"
        [ -f "frontend/index.html" ] && echo "‚úÖ Frontend exists"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      if: secrets.DOCKERHUB_USERNAME != ''
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Log in to GitHub Container Registry
      if: secrets.DOCKERHUB_USERNAME == ''
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Python service
      uses: docker/build-push-action@v4
      with:
        context: ./backend/python
        push: ${{ secrets.DOCKERHUB_USERNAME != '' || github.ref == 'refs/heads/main' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME != '' && format('{0}/python-users-service:latest', env.IMAGE_NAME_PYTHON) || format('ghcr.io/{0}/python-users-service:latest', github.repository_owner) }}
          ${{ secrets.DOCKERHUB_USERNAME != '' && format('{0}/python-users-service:{1}', env.IMAGE_NAME_PYTHON, github.sha) || format('ghcr.io/{0}/python-users-service:{1}', github.repository_owner, github.sha) }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
    
    - name: Build and push Java service
      uses: docker/build-push-action@v4
      with:
        context: ./backend/java
        push: ${{ secrets.DOCKERHUB_USERNAME != '' || github.ref == 'refs/heads/main' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME != '' && format('{0}/java-products-service:latest', env.IMAGE_NAME_JAVA) || format('ghcr.io/{0}/java-products-service:latest', github.repository_owner) }}
          ${{ secrets.DOCKERHUB_USERNAME != '' && format('{0}/java-products-service:{1}', env.IMAGE_NAME_JAVA, github.sha) || format('ghcr.io/{0}/java-products-service:{1}', github.repository_owner, github.sha) }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
    
    - name: Update deployment manifest
      if: success()
      run: |
        # –°–æ–∑–¥–∞–µ–º deployment –º–∞–Ω–∏—Ñ–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ —Ç–µ–≥–∞–º–∏
        mkdir -p deployment
        cp docker-compose.prod.simple.yml deployment/docker-compose.yml
        
        if [ "${{ secrets.DOCKERHUB_USERNAME }}" != "" ]; then
          sed -i "s|build: ./backend/python|image: ${{ secrets.DOCKERHUB_USERNAME }}/python-users-service:latest|g" deployment/docker-compose.yml
          sed -i "s|build: ./backend/java|image: ${{ secrets.DOCKERHUB_USERNAME }}/java-products-service:latest|g" deployment/docker-compose.yml
        fi
        
        echo "Deployment manifest updated"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v3
      with:
        name: deployment-package
        path: |
          deployment/
          scripts/
          database/

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.SERVER_HOST != ''
    
    steps:
    - name: Download deployment artifact
      uses: actions/download-artifact@v3
      with:
        name: deployment-package
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server
      run: |
        echo "Deploying to ${{ secrets.SERVER_HOST }}"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp -r deployment/* ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/opt/fullstack-app/
        scp -r scripts/* ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/opt/fullstack-app/scripts/
        scp -r database/* ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/opt/fullstack-app/database/
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} "
          cd /opt/fullstack-app &&
          docker-compose down &&
          docker-compose pull &&
          docker-compose up -d --remove-orphans &&
          sleep 10 &&
          docker-compose ps
        "
    
    - name: Verify deployment
      run: |
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} "
          echo '=== Deployment Verification ===' &&
          docker-compose ps &&
          echo '' &&
          echo '=== Service Health ===' &&
          curl -f http://localhost:8000/health || echo 'Python service check failed' &&
          curl -f http://localhost:8080/ || echo 'Java service check failed'
        "
    
    - name: Send deployment notification
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        author_name: GitHub Actions
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  status-report:
    needs: [test, build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create status report
      run: |
        echo "=== CI/CD Pipeline Status ==="
        echo "Event: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Jobs:"
        echo "- Test: ${{ needs.test.result }}"
        echo "- Build: ${{ needs.build-and-push.result }}"
        echo "- Deploy: ${{ needs.deploy.result || 'skipped' }}"
        echo ""
        echo "üëâ View details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
